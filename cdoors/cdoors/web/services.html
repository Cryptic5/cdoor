<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Services</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="navbar">
    <a href="index.html" class="logo-btn">cdoors</a>
    <div class="nav-options" id="nav-options"></div>
  </div>
</header>

<div class="content">
  <h1 class="title" id="greeting"></h1>
  <p>Here are the services we provide:</p>
  <div class="service">
    <h2>VM Hosting</h2>
    <p>We provide reliable and scalable virtual machine hosting services to suit your needs.</p>
    <label for="vm-name">Enter Virtual Machine Name</label>
    <input type="text" id="vm-name" name="vm-name" placeholder="Enter VM name" required>
    <button class="btn" id="create-vm-btn">Order a Virtual Machine</button>
  </div>
</div>

<script>
  function updateUI() {
    const navOptions = document.getElementById('nav-options');
    const greeting = document.getElementById('greeting');
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    navOptions.innerHTML = '<a href="index.html">Home</a>';

    if (loggedInUser) {
      greeting.innerText = `Hello, ${loggedInUser.username}!`;
      navOptions.innerHTML += `
        <a href="index.html" onclick="logout()">Logout</a>
      `;
    } else {
      greeting.innerText = '';
      navOptions.innerHTML += `
        <a href="login.html">Log In</a>
        <a href="register.html">Register</a>
      `;
    }
  }

  function logout() {
    localStorage.removeItem('loggedInUser');
    updateUI();
  }

  document.getElementById('create-vm-btn').addEventListener('click', function () {

    const vmName = document.getElementById('vm-name').value;
    if (!vmName) {
      alert('Please enter a VM name.');
      return;
    }
    const template = 'ubuntu-24.04';

    const vmData = {
      vm_name: vmName,  // Use the dynamic value
      template: template  // Use the hardcoded template value
    };

    fetch('/cgi-bin/vm.py', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams(vmData)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to communicate with the server');
              }
              return response.json();
            })
            .then(data => {
              if (data.status === "success") {
                localStorage.setItem('private_ip', data.private_ip);
                localStorage.setItem('connect_info1', data.connect_info1);
                window.location.href = 'vm_info.html';
              } else {
                alert(`Error: ${data.message}`);
              }
            })
            .catch(error => {
              alert('Error creating VM: ' + error.message);
            });
  });

  updateUI();
</script>
</body>
</html>
